define("icybee/images/save-operation",[],function(){return new Class({options:{constructor:"files",url:""},Implements:[Options,Events],initialize:function(a){this.setOptions(a)},process:function(a){var b=new XMLHttpRequest,c=this.createFormData(a);b.onreadystatechange=this.onReadyStateChange.bind(this),b.upload.onprogress=this.onProgress.bind(this),b.upload.onload=this.onProgress.bind(this),b.open("POST",this.options.url),b.setRequestHeader("Accept","application/json"),b.setRequestHeader("X-Requested-With","XMLHttpRequest"),b.setRequestHeader("X-Request","JSON"),this.request(b),b.send(c)},createFormData:function(a){var b=new FormData;return b.append(ICanBoogie.Operation.DESTINATION,this.options.constructor),b.append(ICanBoogie.Operation.NAME,"save"),Object.each(a,function(a,c){b.append(c,a)}),b},onReadyStateChange:function(a){var b=a.target;if(b.readyState==XMLHttpRequest.DONE){if(200==b.status)try{this.success(JSON.decode(b.responseText),b)}catch(c){console&&console.error(c),this.failure(b)}else b.status>=400&&this.failure(b);this.complete(b)}},onProgress:function(a){this.fireEvent("progress",a)},request:function(a){this.fireEvent("request",a)},success:function(a,b){this.fireEvent("success",a,b)},failure:function(a){this.fireEvent("failure",a)},complete:function(a){this.fireEvent("complete",a)}})}),define("icybee/images/image-control",["icybee/images/save-operation"],function(a){return new Class({options:{maxFileSize:0,maxFileSizeAlert:"The selected file is too big.",acceptedExtensions:null,acceptedExtensionsAlert:"Wrong file type."},Implements:[Options,Events],initialize:function(a,b){this.element=a,this.fileElement=a.querySelector('[type="file"]'),this.nidElement=a.querySelector('[type="hidden"]'),this.progressPositionElement=a.querySelector(".progress-position"),this.alertContentElement=a.querySelector(".alert .content"),this.defaultAlertMessage=this.alertContentElement.innerHTML,this.setOptions(b),"string"==typeOf(this.options.acceptedExtensions)&&(this.options.acceptedExtensions=this.options.acceptedExtensions.split(" ")),this.fileElement.addEvent("change",function(a){this.start()}.bind(this)),a.addEventListener("dragover",this.onDragover.bind(this),!1),a.addEventListener("dragleave",this.onDragleave.bind(this),!1),a.addEventListener("drop",this.onDrop.bind(this),!1)},onDragover:function(a){a.preventDefault(),this.element.addClass("dnd-hover")},onDragleave:function(a){a.preventDefault(),this.element.removeClass("dnd-hover")},onDrop:function(a){a.stopPropagation(),a.preventDefault(),this.element.removeClass("dnd-hover");var b=a.target.files||a.dataTransfer.files;this.upload(b[0])},setPosition:function(a){this.progressPositionElement.setStyle("width",100*a+"%"),this.element.querySelector(".progress-label").innerHTML=Math.round(100*a)+"%"},alert:function(a){this.alertContentElement.innerHTML=a,this.element.addClass("has-error")},validate:function(a){var b=this.options.acceptedExtensions,c=this.options.maxFileSize;return b&&(b=b.join("|").replace(/\./g,""),b=new RegExp(".("+b+")$"),!b.test(a.name))?(this.alert(this.options.acceptedExtensionsAlert),!1):a.size>c?(this.alert(this.options.maxFileSizeAlert),!1):!0},start:function(){var a=this.fileElement.files;this.upload(a[0])},upload:function(b){if(this.validate(b)){var c=new a({constructor:"images",onRequest:this.request.bind(this),onSuccess:this.success.bind(this),onFailure:this.failure.bind(this),onComplete:this.complete.bind(this),onProgress:this.progress.bind(this)}),d=this.nidElement.get("value"),e={path:b,is_online:!0};d&&(e[ICanBoogie.Operation.KEY]=d),c.process(e)}},request:function(a){this.setPosition(0),this.element.removeClass("has-error"),this.element.addClass("uploading"),this.fireEvent("request",arguments)},success:function(a,b){this.setValue(a.rc.key),this.fireEvent("success",arguments)},failure:function(a){var b=this.defaultAlertMessage;try{response=JSON.decode(a.responseText),response.errors.path?b=response.errors.path:response.exception&&(b=response.errors.path)}catch(c){}this.alert(b),this.fireEvent("failure",arguments)},complete:function(a){this.element.removeClass("uploading"),this.fireEvent("complete",arguments)},progress:function(a){if(a.lengthComputable){var b=a.loaded/a.total;this.setPosition(b)}this.fireEvent("progress",arguments)},setValue:function(a){this.nidElement.value=a,this.fireEvent("change",a)},getValue:function(){return this.nidElement.value}})}),!function(a){var b;a.register("ImageControl",function(a,c){return b||(b=require("icybee/images/image-control")),new b(a,c)})}(Brickrouge),define("icybee/images/image-control-with-preview",["brickrouge"],function(a){return new Class({options:{thumbnailVersion:"$popimage"},initialize:function(b,c){var d;this.element=b=document.id(b),this.imgElement=b.getElement("img"),this.control=d=a.from(b.getElement("["+a.IS_ATTRIBUTE+"]")),this.control.addEvent("change",this.rethinkState.bind(this)),b.addEventListener("dragover",function(a){d.onDragover(a)},!1),b.addEventListener("dragleave",function(a){d.onDragleave(a)},!1),b.addEventListener("drop",function(a){d.onDrop(a)},!1),b.addEvent('click:relay([data-dismiss="value"])',function(){this.setValue(null)}.bind(this)),this.rethinkState()},rethinkState:function(){var a=this.getValue(),b=0|a?"/api/images/"+a+"/thumbnails/"+this.options.thumbnailVersion+"?no-cache="+(new Date).getTime().toString(16):"";this.imgElement.src=b,this.element[b?"removeClass":"addClass"]("empty")},setValue:function(a){this.control.setValue(a),this.rethinkState()},getValue:function(a){return this.control.getValue()}})}),!function(a){var b;a.register("ImageControlWithPreview",function(a,c){return b||(b=require("icybee/images/image-control-with-preview")),new b(a,c)})}(Brickrouge),define("icybee/images/adjust-image",["icybee/nodes/adjust-node"],function(a){return a}),!function(a){var b;a.register("AdjustImage",function(a,c){return b||(b=require("icybee/images/adjust-image")),new b(a,c)})}(Brickrouge),define("icybee/images/adjust-thumbnail",["brickrouge"],function(a){return new Class({Implements:[Events],initialize:function(b,c){this.element=b,this.control=b.querySelector('input[type="hidden"]'),this.thumbnailOptions=a.from(b.querySelector(".widget-adjust-thumbnail-options")),this.image=a.from(b.querySelector(".widget-adjust-image")),this.thumbnailOptions.addEvent("change",this.onChange.bind(this)),this.image.addEvent("change",this.onChange.bind(this)),b.getFirst(".more").addEvent("click",function(a){this.element.toggleClass("unfold-thumbnail"),this.fireEvent("adjust",{target:this.element,widget:this})}.bind(this))},decodeOptions:function(a){var b=a.match(/\/images\/(\d+|[^\/]+)(\/(\d*)x(\d*)(\/([a-z\-]+))?)?/),c=b[1],d=b[3]||null,e=b[4]||null,f=b[6],g=a.indexOf("?"),h={};return g&&(h=a.substring(g+1).parseQueryString()),c&&(h.nid=c),h.width=d,h.height=e,h.method=f,h},setValue:function(a){var b={nid:null},c=null;"element"==typeOf(a)&&(c=a,a=c.get("data-nid")||c.get("src")),"string"==typeOf(a)&&-1!==a.indexOf("/images/")?b=this.decodeOptions(a):"object"==typeOf(a)?b=a:b.nid=a,c&&(b.width=c.get("width")||b.width,b.height=c.get("height")||b.height),this.image.setValue(b.nid),this.thumbnailOptions.setValue(b)},getValue:function(){var a=this.image.getSelected(),b=this.thumbnailOptions.getValue(),c=null,d=null;if(a){var e=a.get("data-nid");try{d=new ICanBoogie.Modules.Thumbnailer.Thumbnail("/images/"+e,b),c=d.toString()}catch(f){console&&console.log(f)}}return c},onChange:function(a){var b=this.image.getSelected();this.fireEvent("change",{target:this,url:this.getValue(),nid:b?b.get("data-nid"):null,selected:b,options:this.thumbnailOptions.getValue()})}})}),!function(a){var b;a.register("AdjustThumbnail",function(a,c){return b||(b=require("icybee/images/adjust-thumbnail")),new b(a,c)})}(Brickrouge),define("icybee/images/pop-image",["icybee/nodes/pop-node"],function(a){return new Class({Extends:a,options:{thumbnailVersion:"$popimage"},initialize:function(a,b){this.parent(a,b),this.img=a.querySelector("img"),this.loader=this.createLoader(this.img)},change:function(a){this.setValue(a.selected.get("data-nid"))},formatValue:function(a){var b=this.img;return a?(this.updateThumbnail(a),b):""},createLoader:function(a){var b=document.createElement("img");return b.onload=function(){var c=a.parentNode;c.removeChild(a),a.setAttribute("width",b.naturalWidth),a.setAttribute("height",b.naturalHeight),a.src=b.src,c.appendChild(a),this.popover&&this.popover.reposition()}.bind(this),b},updateThumbnail:function(a){this.loader.src="/images/"+a+"/thumbnails/"+this.options.thumbnailVersion+"?_r="+Date.now()}})}),!function(a){var b;a.register("PopImage",function(a,c){return b||(b=require("icybee/images/pop-image")),new b(a,c)})}(Brickrouge),define("icybee/images/pop-or-upload-image",["brickrouge"],function(a){const b="upload-mode",c="create",d="update";var e=new Class({initialize:function(b,c){this.element=b;var e=a.from(b.querySelector(".widget-pop-image")),f=a.from(b.querySelector(".widget-file")),g=null;f.options.uploadMode==d&&(g=e.getValue()),f.addEvents({prepare:function(a){var b=a.data;b.append("title",a.file.name),b.append("is_online",!0),g&&b.append(ICanBoogie.Operation.KEY,g)},success:function(a){g=a.rc.key,e.setValue(a.rc.key)}})}});return e.UPLOAD_MODE=b,e.UPLOAD_MODE_CREATE=c,e.UPLOAD_MODE_UPDATE=d,e}),!function(a){var b;a.register("PopOrUploadImage",function(a,c){return b||(b=require("icybee/images/pop-or-upload-image")),new b(a,c)})}(Brickrouge);