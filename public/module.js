define("icybee/images/save-operation",[],function(){return new Class({options:{constructor:"files",url:""},Implements:[Options,Events],initialize:function(b){this.setOptions(b)},process:function(b){var a=new XMLHttpRequest;b=this.createFormData(b);a.onreadystatechange=this.onReadyStateChange.bind(this);a.upload.onprogress=this.onProgress.bind(this);a.upload.onload=this.onProgress.bind(this);a.open("POST",this.options.url);a.setRequestHeader("Accept","application/json");a.setRequestHeader("X-Requested-With",
"XMLHttpRequest");a.setRequestHeader("X-Request","JSON");this.request(a);a.send(b)},createFormData:function(b){var a=new FormData;a.append(ICanBoogie.Operation.DESTINATION,this.options.constructor);a.append(ICanBoogie.Operation.NAME,"save");Object.each(b,function(d,b){a.append(b,d)});return a},onReadyStateChange:function(b){b=b.target;if(b.readyState==XMLHttpRequest.DONE){if(200==b.status)try{this.success(JSON.decode(b.responseText),b)}catch(a){console&&console.error(a),this.failure(b)}else 400<=
b.status&&this.failure(b);this.complete(b)}},onProgress:function(b){this.fireEvent("progress",b)},request:function(b){this.fireEvent("request",b)},success:function(b,a){this.fireEvent("success",b,a)},failure:function(b){this.fireEvent("failure",b)},complete:function(b){this.fireEvent("complete",b)}})});
define("icybee/images/image-control",["icybee/images/save-operation"],function(b){return new Class({options:{maxFileSize:0,maxFileSizeAlert:"The selected file is too big.",acceptedExtensions:null,acceptedExtensionsAlert:"Wrong file type."},Implements:[Options,Events],initialize:function(a,d){this.element=a;this.fileElement=a.querySelector('[type="file"]');this.nidElement=a.querySelector('[type="hidden"]');this.progressPositionElement=a.querySelector(".progress-position");this.alertContentElement=
a.querySelector(".alert .content");this.defaultAlertMessage=this.alertContentElement.innerHTML;this.setOptions(d);"string"==typeOf(this.options.acceptedExtensions)&&(this.options.acceptedExtensions=this.options.acceptedExtensions.split(" "));this.fileElement.addEvent("change",function(a){this.start()}.bind(this));a.addEventListener("dragover",this.onDragover.bind(this),!1);a.addEventListener("dragleave",this.onDragleave.bind(this),!1);a.addEventListener("drop",this.onDrop.bind(this),!1)},onDragover:function(a){a.preventDefault();
this.element.addClass("dnd-hover")},onDragleave:function(a){a.preventDefault();this.element.removeClass("dnd-hover")},onDrop:function(a){a.stopPropagation();a.preventDefault();this.element.removeClass("dnd-hover");this.upload((a.target.files||a.dataTransfer.files)[0])},setPosition:function(a){this.progressPositionElement.setStyle("width",100*a+"%");this.element.querySelector(".progress-label").innerHTML=Math.round(100*a)+"%"},alert:function(a){this.alertContentElement.innerHTML=a;this.element.addClass("has-error")},
validate:function(a){var d=this.options.acceptedExtensions,b=this.options.maxFileSize;return d&&(d=d.join("|").replace(/\./g,""),d=new RegExp(".("+d+")$"),!d.test(a.name))?(this.alert(this.options.acceptedExtensionsAlert),!1):a.size>b?(this.alert(this.options.maxFileSizeAlert),!1):!0},start:function(){this.upload(this.fileElement.files[0])},upload:function(a){if(this.validate(a)){var d=new b({constructor:"images",onRequest:this.request.bind(this),onSuccess:this.success.bind(this),onFailure:this.failure.bind(this),
onComplete:this.complete.bind(this),onProgress:this.progress.bind(this)}),c=this.nidElement.get("value");a={path:a,is_online:!0};c&&(a[ICanBoogie.Operation.KEY]=c);d.process(a)}},request:function(a){this.setPosition(0);this.element.removeClass("has-error");this.element.addClass("uploading");this.fireEvent("request",arguments)},success:function(a,d){this.setValue(a.rc.key);this.fireEvent("success",arguments)},failure:function(a){var d=this.defaultAlertMessage;try{response=JSON.decode(a.responseText),
response.errors.path?d=response.errors.path:response.exception&&(d=response.errors.path)}catch(b){}this.alert(d);this.fireEvent("failure",arguments)},complete:function(a){this.element.removeClass("uploading");this.fireEvent("complete",arguments)},progress:function(a){a.lengthComputable&&this.setPosition(a.loaded/a.total);this.fireEvent("progress",arguments)},setValue:function(a){this.nidElement.value=a;this.fireEvent("change",a)},getValue:function(){return this.nidElement.value}})});
!function(b){var a;b.register("ImageControl",function(d,b){a||(a=require("icybee/images/image-control"));return new a(d,b)})}(Brickrouge);
define("icybee/images/image-control-with-preview",["brickrouge"],function(b){return new Class({options:{thumbnailVersion:"$popimage"},initialize:function(a,d){var c;this.element=a=document.id(a);this.imgElement=a.getElement("img");this.control=c=b.from(a.getElement("["+b.IS_ATTRIBUTE+"]"));this.control.addEvent("change",this.rethinkState.bind(this));a.addEventListener("dragover",function(a){c.onDragover(a)},!1);a.addEventListener("dragleave",function(a){c.onDragleave(a)},!1);a.addEventListener("drop",
function(a){c.onDrop(a)},!1);a.addEvent('click:relay([data-dismiss="value"])',function(){this.setValue(null)}.bind(this));this.rethinkState()},rethinkState:function(){var a=this.getValue(),a=a|0?"/api/images/"+a+"/thumbnails/"+this.options.thumbnailVersion+"?no-cache="+(new Date).getTime().toString(16):"";this.imgElement.src=a;this.element[a?"removeClass":"addClass"]("empty")},setValue:function(a){this.control.setValue(a);this.rethinkState()},getValue:function(a){return this.control.getValue()}})});
!function(b){var a;b.register("ImageControlWithPreview",function(b,c){a||(a=require("icybee/images/image-control-with-preview"));return new a(b,c)})}(Brickrouge);define("icybee/images/adjust-image",["icybee/nodes/adjust-node"],function(b){return b});!function(b){var a;b.register("AdjustImage",function(b,c){a||(a=require("icybee/images/adjust-image"));return new a(b,c)})}(Brickrouge);
define("icybee/images/adjust-thumbnail",["brickrouge"],function(b){return new Class({Implements:[Events],initialize:function(a,d){this.element=a;this.control=a.querySelector('input[type="hidden"]');this.thumbnailOptions=b.from(a.querySelector(".widget-adjust-thumbnail-options"));this.image=b.from(a.querySelector(".widget-adjust-image"));this.thumbnailOptions.addEvent("change",this.onChange.bind(this));this.image.addEvent("change",this.onChange.bind(this));a.getFirst(".more").addEvent("click",function(a){this.element.toggleClass("unfold-thumbnail");
this.fireEvent("adjust",{target:this.element,widget:this})}.bind(this))},decodeOptions:function(a){var b=a.match(/\/images\/(\d+|[^\/]+)(\/(\d*)x(\d*)(\/([a-z\-]+))?)?/),c=b[1],e=b[3]||null,f=b[4]||null,b=b[6],g=a.indexOf("?"),h={};g&&(h=a.substring(g+1).parseQueryString());c&&(h.nid=c);h.width=e;h.height=f;h.method=b;return h},setValue:function(a){var b={nid:null},c=null;"element"==typeOf(a)&&(c=a,a=c.get("data-nid")||c.get("src"));"string"==typeOf(a)&&-1!==a.indexOf("/images/")?b=this.decodeOptions(a):
"object"==typeOf(a)?b=a:b.nid=a;c&&(b.width=c.get("width")||b.width,b.height=c.get("height")||b.height);this.image.setValue(b.nid);this.thumbnailOptions.setValue(b)},getValue:function(){var a=this.image.getSelected(),b=this.thumbnailOptions.getValue(),c=null,e=null;if(a){a=a.get("data-nid");try{e=new ICanBoogie.Modules.Thumbnailer.Thumbnail("/images/"+a,b),c=e.toString()}catch(f){console&&console.log(f)}}return c},onChange:function(a){a=this.image.getSelected();this.fireEvent("change",{target:this,
url:this.getValue(),nid:a?a.get("data-nid"):null,selected:a,options:this.thumbnailOptions.getValue()})}})});!function(b){var a;b.register("AdjustThumbnail",function(b,c){a||(a=require("icybee/images/adjust-thumbnail"));return new a(b,c)})}(Brickrouge);
define("icybee/images/pop-image",["icybee/nodes/pop-node"],function(b){return new Class({Extends:b,options:{thumbnailVersion:"$popimage"},initialize:function(a,b){this.parent(a,b);this.img=a.querySelector("img");this.loader=this.createLoader(this.img)},change:function(a){this.setValue(a.selected.get("data-nid"))},formatValue:function(a){var b=this.img;if(!a)return"";this.updateThumbnail(a);return b},createLoader:function(a){var b=document.createElement("img");b.onload=function(){var c=a.parentNode;
c.removeChild(a);a.setAttribute("width",b.naturalWidth);a.setAttribute("height",b.naturalHeight);a.src=b.src;c.appendChild(a);this.popover&&this.popover.reposition()}.bind(this);return b},updateThumbnail:function(a){this.loader.src="/images/"+a+"/thumbnails/"+this.options.thumbnailVersion+"?_r="+Date.now()}})});!function(b){var a;b.register("PopImage",function(b,c){a||(a=require("icybee/images/pop-image"));return new a(b,c)})}(Brickrouge);
define("icybee/images/pop-or-upload-image",["brickrouge"],function(b){var a=function(a,c){this.element=a;this.options=c;var e=b.from(a.querySelector(".widget-pop-image")),f=b.from(a.querySelector(".widget-file")),g=null;"update"==f.options.uploadMode&&(g=e.getValue());f.observe(b.File.EVENT_PREPARE,function(a){var b=a.data;b.append("title",a.file.name);b.append("is_online",!0);g&&b.append(ICanBoogie.Operation.KEY,g)});f.observe(b.File.EVENT_SUCCESS,function(a){e.setValue(a.response.rc.key)})};Object.defineProperties(a,
{UPLOAD_MODE:{value:"upload-mode"},UPLOAD_MODE_CREATE:{value:"create"},UPLOAD_MODE_UPDATE:{value:"update"}});return a});!function(b){var a;b.register("PopOrUploadImage",function(b,c){a||(a=require("icybee/images/pop-or-upload-image"));return new a(b,c)})}(Brickrouge);
